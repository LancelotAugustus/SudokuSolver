# Sudoku Solver (v0.3.0)

## 项目整体结构

```
SudokuSolver/
└── src/
    ├── sudoku/           # 数独求解器核心包
    │   ├── __init__.py   # 包初始化文件，定义公开接口和版本信息
    │   ├── exception.py  # 自定义异常处理模块
    │   ├── board.py      # 棋盘管理模块
    │   ├── rules.py      # 规则定义模块
    │   └── solver.py     # 求解器模块
    └── main.py           # 使用示例和主程序
```

## 模块详细说明

### 1. 异常处理模块 (exception.py)

**功能**：自定义异常处理模块，处理数独求解过程中的异常情况
**核心组件**：`SudokuError` 异常类

**特点**：
- 继承自Python标准异常类`Exception`
- 专门用于处理数独棋盘与规则的兼容性问题
- 构造函数接收规则名称和可选的错误信息，自动生成格式化的错误消息
- 提供 `rule_name` 属性获取引发异常的规则名称
- 错误信息格式为："错误信息 (规则: 规则名称)"

### 2. 棋盘数据管理模块 (board.py)

**功能**：棋盘数据管理模块，定义Board类用于管理棋盘状态
**核心组件**：`Board` 类

**属性**：
- `size`: 棋盘尺寸（n×n），必须是正整数
- `grid`: 二维整数列表，存储棋盘数字状态，0表示空格

**方法**：
- `__init__(size)`: 初始化数独棋盘，创建指定尺寸的空棋盘，验证size必须为正整数，否则抛出`ValueError`
- `__str__()`: 返回棋盘的可视化字符串表示，用"."表示空格，用空格分隔每个数字
- `configure(clue)`: 根据字符串配置初始棋盘状态，字符串使用空格分隔数字，验证字符串长度必须等于棋盘格子总数，且每个字符必须为有效数字字符，数字必须在0到size之间，否则抛出`ValueError`
- `get(row, col)`: 安全获取指定位置的数字
- `set(row, col, digit)`: 在指定位置放置数字
- `remove(row, col)`: 移除指定位置的数字（设置为0）
- `find()`: 查找第一个空格位置，返回`Optional[tuple[int, int]]`
- `copy()`: 创建棋盘的深拷贝，返回类型使用字符串字面量`'Board'`

### 3. 数独规则定义模块 (rules.py)

**功能**：数独规则定义模块，定义抽象规则类和具体规则实现
**核心组件**：
- `Rule` 抽象基类
- `NormalSudokuRowRule` 类（行规则）
- `NormalSudokuColumnRule` 类（列规则）
- `Normal9x9SudokuBlockRule` 类（9×9宫规则）

**Rule抽象基类**：
- 提供`__init__()`方法，自动设置`rule_name`为类名
- 提供`__str__()`方法，返回规则名称
- 提供`check(board)`抽象方法，检查规则满足情况
- 提供`test(board)`默认方法，不进行任何检查（子类可重写）

**具体规则类**：
1. **行规则** (`NormalSudokuRowRule`)：
   - 检查每行数字1-n不重复（n为棋盘尺寸）
   - 支持任意尺寸棋盘
   - 使用`board.get(row, col)`安全获取数字
   - 使用基类默认`test()`方法（不进行兼容性检查）

2. **列规则** (`NormalSudokuColumnRule`)：
   - 检查每列数字1-n不重复（n为棋盘尺寸）
   - 支持任意尺寸棋盘
   - 使用`board.get(row, col)`安全获取数字
   - 使用基类默认`test()`方法（不进行兼容性检查）

3. **宫规则** (`Normal9x9SudokuBlockRule`)：
   - 检查每个3×3宫内数字1-9不重复
   - **仅适用于9×9棋盘**
   - 重写`test()`方法，检查棋盘尺寸是否为9，不符合时抛出`SudokuError`
   - 实现`check()`方法，检查9个3×3宫的规则满足情况

### 4. 求解器核心模块 (solver.py)

**功能**：数独求解器模块，实现回溯算法求解数独
**核心组件**：`Solver` 类

**属性**：
- `board`: 棋盘副本（用于求解操作，不修改原始棋盘）
- `rules`: 规则元组（保存所有应用的规则）
- `steps`: 求解步数计数器（包括尝试和回溯操作）

**方法**：
- `__init__(board, *rules)`: 初始化求解器，复制棋盘，遍历所有规则调用`rule.test(board)`验证兼容性
- `check()`: 检查当前棋盘是否满足所有规则，遍历所有规则调用`rule.check(board)`
- `trial(row, col, digit)`: 尝试在指定位置放置数字，记录原始数字，放置新数字，验证规则，如果不满足则恢复原始状态
- `solve()`: 递归回溯求解算法，查找空格，尝试所有可能的数字（1到board.size），递归调用自身求解剩余棋盘
- `solution()`: 获取求解结果，调用`solve()`方法，如果成功返回棋盘的深拷贝，否则返回None

### 5. 应用程序入口 (main.py)

**功能**：数独求解器使用示例和主程序

**使用流程**：
1. 创建9×9数独棋盘实例
2. 设置经典数独初始局面（9×9难度中等）
3. 创建三种规则实例（行规则、列规则、宫规则）
4. 初始化求解器并求解
5. 显示初始局面、求解步数和最终解

## 代码执行流程

### 初始化阶段
1. 创建`Board`实例，指定尺寸为9，验证尺寸是否为正整数
2. 调用`board.configure(clue)`配置初始局面，验证字符串长度必须为81（9×9），每个字符必须是数字且在0-9范围内
3. 创建三个规则实例（行规则、列规则、宫规则）
4. 创建`Solver`实例，传入棋盘和规则，验证规则兼容性（特别是宫规则需要棋盘尺寸为9）

### 求解阶段
1. 调用`solver.solution()`
2. 调用内部`solve()`方法开始递归求解：
   - 调用`board.find()`查找第一个空格
   - 如果没有空格，调用`check()`验证棋盘是否完全满足规则
   - 如果有空格，获取位置(row, col)
   - 循环尝试数字1到board.size（即9）
   - 对每个数字调用`trial(row, col, digit)`方法：
     - 增加步数计数
     - 记录原始数字
     - 放置新数字
     - 调用`check()`验证
     - 如果验证失败，恢复原始数字
     - 返回验证结果
   - 如果`trial()`成功，递归调用`solve()`处理下一个空格
   - 如果递归成功，返回True
   - 如果递归失败或所有数字尝试失败，调用`board.remove(row, col)`回溯
   - 返回False表示当前分支无解
3. 如果`solve()`返回True，返回棋盘的深拷贝，否则返回None

### 结果展示阶段
1. 打印初始棋盘状态（使用"."表示空格）
2. 显示求解成功状态和使用的步数
3. 打印最终解（如果存在）

## 使用注意事项

1. 对于非9×9数独，不要使用`Normal9x9SudokuBlockRule`规则，否则会抛出`SudokuError`
2. 字符串配置棋盘时，数字必须用空格分隔
3. 棋盘尺寸必须为正整数，理论上支持任意尺寸，但过大尺寸可能导致性能问题
4. 规则系统的设计允许用户自定义规则，只需继承`Rule`基类并实现`check()`和可选的`test()`方法